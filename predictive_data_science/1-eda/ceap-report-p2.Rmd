---
title: "Ceap Report [p. 2]"
author: "Italo Batista"
date: "September 5, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Perguntas
- 1. Quais os tipos de despesas com os deputados que, no total, foram maiores do que o investimento com o Museu Nacional nos úlitmos anos?  
- 2. Quais as datas (mes/ano) em que os deputados mais gastaram? Qual foi o tipo de despesa mais consumida?  

## Importando dados

Os dados foram baixados por meio [desta página](http://www2.camara.leg.br/transparencia/cota-para-exercicio-da-atividade-parlamentar/dados-abertos-cota-parlamentar)

```{r message=FALSE, warning=FALSE, error=FALSE}
require(readr)
require(here)

data_folder = here::here("predictive_data_science/data/ceap")
for(year in c(2009:2018)) {
  file_name = paste("Ano-", year, ".csv", sep="")
  path_to_data = paste(data_folder, file_name, sep="/")
  curr_data = read_delim(path_to_data, delim = ";", escape_double = FALSE, trim_ws = TRUE)
  
  if (!exists("data.ceap")) {
    data.ceap = curr_data
  } else {
    data.ceap = rbind(data.ceap, curr_data)
  }
}

investiment.mn = read_delim(here::here("predictive_data_science/data/investimento-mn.csv"), 
                            delim="\t", escape_double = FALSE, trim_ws = TRUE)

rm(curr_data)
```


## Pré-processando

```{r message=FALSE, warning=FALSE, error=FALSE}
require(tidyverse)

varsOfInterest = c("txNomeParlamentar", "idecadastro", "sgPartido", "sgUF", 
                   "txtDescricao", "txtFornecedor", "vlrLiquido", "numMes", "numAno")

data.ceap = data.ceap %>%
  
  # Selecionando apenas variáveis de interesse  
  select(varsOfInterest) %>%

  # Substituindo víruglas por pontos
  mutate(vlrLiquido = str_replace_all(vlrLiquido,"[[:punct:]]", ".")) %>%
  mutate(vlrLiquido = as.numeric(vlrLiquido)) %>%
  
  # Renomeando algumas vars
  mutate(year = numAno,
         tipoDespesa = txtDescricao,
         nomeParlamentar = txNomeParlamentar,
         valorLíquido = vlrLiquido) 
```

## Quais os tipos de despesas com os deputados que, no total, foram maiores do que o investimento com o Museu Nacional?

```{r message=FALSE, warning=FALSE, error=FALSE}
require(lubridate)
require(tidyverse)

data.ceap.by.year = data.ceap %>%
  group_by(year, tipoDespesa) %>%
  summarise(totalExpenditure = sum(valorLíquido)) %>%
  ungroup() %>%
  na.omit()
```

```{r}
theme_set(theme_minimal())
```

```{r message=FALSE, warning=FALSE, error=FALSE}
investiment.mn %>%
  ggplot(aes(x=year, y=investiment), fill="deepink") +
  geom_point() + 
  geom_line(linetype = 2) +
  scale_x_continuous(breaks = c(2001:2018))
```

```{r message=FALSE, warning=FALSE, error=FALSE}

```

```{r message=FALSE, warning=FALSE, error=FALSE}
require(tidyverse)
require(scales)

max.year = max(data.ceap.by.year$year)
min.year = min(data.ceap.by.year$year)

investiment.mn.filter.year = investiment.mn %>%
  filter(year <= max.year & year >= min.year)

ggplot() +
  geom_line(data=data.ceap.by.year, aes(x=year, y=totalExpenditure, group=tipoDespesa), linetype = 2, size=0.3) +
  geom_line(data=investiment.mn.filter.year, aes(x=year, y=investiment), color="red") +
  geom_point(data=investiment.mn.filter.year, aes(x=year, y=investiment), alpha=0.3) + 
  scale_x_continuous(breaks=c(min.year:max.year))

```

```{r message=FALSE, warning=FALSE, error=FALSE}

```

```{r message=FALSE, warning=FALSE, error=FALSE}

```