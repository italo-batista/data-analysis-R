---
title: "Ceap Report [p. 2]"
author: "Italo Batista"
date: "September 5, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Perguntas
- 1. Quais as datas (mes/ano) em que os deputados mais gastaram? Qual foi o tipo de despesa mais consumida?  
- 2. Quais os tipos de despesas com os deputados que, no total, foram maiores do que o investimento com o Museu Nacional nos úlitmos anos?  

## Importando dados

Os dados foram baixados por meio [desta página](http://www2.camara.leg.br/transparencia/cota-para-exercicio-da-atividade-parlamentar/dados-abertos-cota-parlamentar)

```{r message=FALSE, warning=FALSE, error=FALSE}
require(readr)
require(here)
require(tidyverse)

data_folder = here::here("predictive_data_science/data/ceap")
for(year in c(2009:2018)) {
  file_name = paste("Ano-", year, ".csv", sep="")
  path_to_data = paste(data_folder, file_name, sep="/")
  curr_data = read_delim(path_to_data, delim = ";", escape_double = FALSE, trim_ws = TRUE)
  
  if (!exists("raw_data")) {
    raw_data = curr_data
  } else {
    raw_data = rbind(raw_data, curr_data)
  }
}

investiment.mn = read_delim(here::here("predictive_data_science/data/investimento-mn.csv"), 
                            delim="\t", escape_double = FALSE, trim_ws = TRUE)
rm(curr_data)
```


## Pré-processando

```{r message=FALSE, warning=FALSE, error=FALSE}
unify_expenditure_type = function(data) {

  data$tipoDespesa = NA
  
  data$tipoDespesa[data$txtDescricao == "MANUTENÇÃO DE ESCRITÓRIO DE APOIO À ATIVIDADE PARLAMENTAR"] = "Escritório"
  data$tipoDespesa[data$txtDescricao == "SERVIÇOS POSTAIS"] = "Serviços Postais"
  data$tipoDespesa[data$txtDescricao %in% c("LOCAÇÃO OU FRETAMENTO DE VEÍCULOS AUTOMOTORES", "LOCAÇÃO OU FRETAMENTO DE AERONAVES", "LOCAÇÃO OU FRETAMENTO DE EMBARCAÇÕES", "LOCAÇÃO DE VEÍCULOS AUTOMOTORES OU FRETAMENTO DE EMBARCAÇÕES")] = "Locação de veículos"
  data$tipoDespesa[data$txtDescricao == "COMBUSTÍVEIS E LUBRIFICANTES."] = "Combustíveis"
  data$tipoDespesa[data$txtDescricao %in% c("PASSAGENS AÉREAS", "Emissão Bilhete Aéreo")] = "Passagens aéreas"
  data$tipoDespesa[data$txtDescricao == "TELEFONIA"] = "Telefonia"
  data$tipoDespesa[data$txtDescricao == "DIVULGAÇÃO DA ATIVIDADE PARLAMENTAR."] = "Divulgação de atividade parlamentar"
  data$tipoDespesa[data$txtDescricao == "FORNECIMENTO DE ALIMENTAÇÃO DO PARLAMENTAR"] = "Alimentação"
  data$tipoDespesa[data$txtDescricao == "HOSPEDAGEM ,EXCETO DO PARLAMENTAR NO DISTRITO FEDERAL."] = "Hospedagem"
  data$tipoDespesa[data$txtDescricao == "SERVIÇO DE TÁXI, PEDÁGIO E ESTACIONAMENTO"] = "Locomoção"
  data$tipoDespesa[data$txtDescricao == "CONSULTORIAS, PESQUISAS E TRABALHOS TÉCNICOS."] = "Consultoria"
  data$tipoDespesa[data$txtDescricao == "ASSINATURA DE PUBLICAÇÕES"] = "Revistas/Jornais"
  data$tipoDespesa[data$txtDescricao == "SERVIÇO DE SEGURANÇA PRESTADO POR EMPRESA ESPECIALIZADA."] = "Segurança particular"
  data$tipoDespesa[data$txtDescricao == "PASSAGENS TERRESTRES, MARÍTIMAS OU FLUVIAIS"] = "Passagens (exceto aéreas)"
  data$tipoDespesa[data$txtDescricao == "PARTICIPAÇÃO EM CURSO, PALESTRA OU EVENTO SIMILAR"] = "Cursos e palestras"
  
  data = data %>% 
    select(-txtDescricao)
  
  return(data)
}
```

```{r message=FALSE, warning=FALSE, error=FALSE}
require(tidyverse)

preprocess_data = function(raw_data, varsOfInterest) {
  data = raw_data %>%
  
    # Selecting just vars on interest
    select(varsOfInterest) %>%
  
    # Replacing commas for points
    mutate(valorLíquido = as.numeric(gsub(",", ".", raw_data$vlrLiquido))) %>%
    
    # Renaming some vars
    mutate(nomeParlamentar = txNomeParlamentar, year = numAno, month = numMes) %>%
    select(-c(txNomeParlamentar, vlrLiquido, numAno, numMes)) %>%
  
    filter(!is.na(idecadastro)) %>%
    
    # Unify expenditures that are of similar categories with the aim of reduce number o categories
    unify_expenditure_type
  
  return(data)
}

varsOfInterest = c("txNomeParlamentar", "idecadastro", "sgPartido", "sgUF", 
                   "txtDescricao", "txtFornecedor", "vlrLiquido", "numAno", "numMes")
data_ceap = preprocess_data(raw_data, varsOfInterest)
```

## Quais as datas (mes/ano) em que os deputados mais gastaram? Qual foi o tipo de despesa mais consumida?

```{r message=FALSE, warning=FALSE, error=FALSE}
require(viridisLite)
require(highcharter)

data_ceap_by_date = data_ceap %>%
  mutate(date = as.Date.character(paste(year, month, "01", sep="-")), "%Y-%m-%d") %>%
  group_by(date, tipoDespesa) %>%
  summarise(totalExpenditure = sum(valorLíquido)) %>%
  ungroup() %>%
  na.omit()
```

```{r message=FALSE, warning=FALSE, error=FALSE}
require(viridisLite)
require(highcharter)
require(lubridate)

colors = viridis(data_ceap_by_date %>% select(tipoDespesa) %>% distinct() %>% nrow())
colors = substr(colors, 0, 7)

title_text = "Comparing expenditure with politicians and investiment in National Museum"

tooltip = paste("<b>Year:</b> {point.date}.<br/>",
                "<b>Total Expenditure (R$):</b> {point.y}. <br/>",
                "<b>Type Expenditure:</b> {point.tipoDespesa}.")

highchart() %>%
  hc_add_series(data_ceap_by_date, "column", hcaes(x = date, y = totalExpenditure, group = tipoDespesa)) %>%
  hc_chart(zoomType = "xy") %>%
  hc_colors(colors) %>%
  hc_plotOptions(column = list(stacking = "normal"), series = list(marker = list(enabled = TRUE))) %>%
  hc_tooltip(headerFormat = "", pointFormat = tooltip) %>%
  hc_title(text = title_text, style = list(fontSize = "18px"), align = "left") %>%
  hc_yAxis(title = list(text = "Total Expenditure (R$)")) %>%
  hc_xAxis(type = 'datetime', labels = list(format = '{value:%Y-%m}'))
```

## Quais os tipos de despesas com os deputados que, no total, foram maiores do que o investimento com o Museu Nacional nos úlitmos anos?

```{r message=FALSE, warning=FALSE, error=FALSE}
require(lubridate)
require(tidyverse)

 data_ceap_by_year =  data_ceap %>%
  group_by(year, tipoDespesa) %>%
  summarise(totalExpenditure = sum(valorLíquido)) %>%
  ungroup() %>%
  na.omit()
```

```{r message=FALSE, warning=FALSE, error=FALSE}
require(highcharter)
    
tltip.title = c("Year:", "Investiment (R$): ")
tltip.vls = sprintf("{point.%s}", c("year", "investiment"))
tltip <- tooltip_table(tltip.title, tltip.vls)

COLOR_RED = "#d11141"

theme_set(theme_minimal())

hchart(investiment.mn, "spline", hcaes(x = year, y = investiment)) %>%
  hc_plotOptions(
    series  = list(
      marker = list(enabled = TRUE, 'x'),
      color = COLOR_RED)) %>%
  hc_title(text = "Investimento ao Museu Nacional ao longo dos últimos anos") %>%
  hc_yAxis(title = list(text = "Valor total do investimento (R$)")) %>%
  hc_xAxis(title = list(text = "Ano")) %>%
  hc_tooltip(table = TRUE, headerFormat = "", pointFormat = tltip)
```

```{r message=FALSE, warning=FALSE, error=FALSE}
require(viridisLite)
require(highcharter)

max.year = max(data_ceap_by_year$year)
min.year = min(data_ceap_by_year$year)

investiment.mn.filter.year = investiment.mn %>%
  filter(year <= max.year & year >= min.year)

colors = viridis(data_ceap_by_year %>% select(tipoDespesa) %>% distinct() %>% nrow())
colors = substr(colors, 0, 7)

title_text = "Politicians' expenditures (by category) VS Investiment in National Museum"

tooltip = paste("<b>Year:</b> {point.x}.<br/>",
                "<b>Total Expenditure (R$):</b> {point.y}. <br/>",
                "<b>Type Expenditure:</b> {point.tipoDespesa}.")

highchart() %>%
  hc_add_series(data = data_ceap_by_year, 
                type = "spline", 
                dashStyle = "shortdot", 
                hcaes(x = year, y = totalExpenditure, group = tipoDespesa)) %>%
  hc_add_series(name = "Museu Nacional", 
                data = investiment.mn.filter.year, 
                type = "spline", 
                hcaes(x = year, y = investiment), 
                color = COLOR_RED,
                lineWidth = 4) %>%
  hc_chart(zoomType = "xy") %>%
  hc_colors(colors) %>%
  hc_plotOptions(spline = list(marker = list(symbol = "circle"))) %>%
  hc_tooltip(headerFormat = "", pointFormat = tooltip) %>%
  hc_title(text = title_text, style = list(fontSize = "18px"), align = "left") %>%
  hc_yAxis(title = list(text = "Total Expenditure (R$)")) %>%
  hc_xAxis(labels = list(enabled = TRUE),
           marker = list(enabled = TRUE),
           categories = 2009:2018)
```
