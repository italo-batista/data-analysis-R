---
title: "Ceap Report [p. 2]"
author: "Italo Batista"
date: "September 5, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Perguntas
- 1. Quais os tipos de despesas com os deputados que, no total, foram maiores do que o investimento com o Museu Nacional nos úlitmos anos?  
- 2. Quais as datas (mes/ano) em que os deputados mais gastaram? Qual foi o tipo de despesa mais consumida?  

## Importando dados

Os dados foram baixados por meio [desta página](http://www2.camara.leg.br/transparencia/cota-para-exercicio-da-atividade-parlamentar/dados-abertos-cota-parlamentar)

```{r message=FALSE, warning=FALSE, error=FALSE}
require(readr)
require(here)
require(tidyverse)

data_folder = here::here("predictive_data_science/data/ceap")
for(year in c(2009:2018)) {
  file_name = paste("Ano-", year, ".csv", sep="")
  path_to_data = paste(data_folder, file_name, sep="/")
  curr_data = read_delim(path_to_data, delim = ";", escape_double = FALSE, trim_ws = TRUE)
  
  if (!exists("raw_data")) {
    raw_data = curr_data
  } else {
    raw_data = rbind(raw_data, curr_data)
  }
}

investiment.mn = read_delim(here::here("predictive_data_science/data/investimento-mn.csv"), 
                            delim="\t", escape_double = FALSE, trim_ws = TRUE)
rm(curr_data)
```


## Pré-processando

```{r message=FALSE, warning=FALSE, error=FALSE}
unify_expenditure_type = function(data) {

  data$tipoDespesa = NA
  
  data$tipoDespesa[data$txtDescricao == "MANUTENÇÃO DE ESCRITÓRIO DE APOIO À ATIVIDADE PARLAMENTAR"] = "Escritório"
  data$tipoDespesa[data$txtDescricao == "SERVIÇOS POSTAIS"] = "Serviços Postais"
  data$tipoDespesa[data$txtDescricao %in% c("LOCAÇÃO OU FRETAMENTO DE VEÍCULOS AUTOMOTORES", "LOCAÇÃO OU FRETAMENTO DE AERONAVES", "LOCAÇÃO OU FRETAMENTO DE EMBARCAÇÕES", "LOCAÇÃO DE VEÍCULOS AUTOMOTORES OU FRETAMENTO DE EMBARCAÇÕES")] = "Locação de veículos"
  data$tipoDespesa[data$txtDescricao == "COMBUSTÍVEIS E LUBRIFICANTES."] = "Combustíveis"
  data$tipoDespesa[data$txtDescricao %in% c("PASSAGENS AÉREAS", "Emissão Bilhete Aéreo")] = "Passagens aéreas"
  data$tipoDespesa[data$txtDescricao == "TELEFONIA"] = "Telefonia"
  data$tipoDespesa[data$txtDescricao == "DIVULGAÇÃO DA ATIVIDADE PARLAMENTAR."] = "Divulgação de atividade parlamentar"
  data$tipoDespesa[data$txtDescricao == "FORNECIMENTO DE ALIMENTAÇÃO DO PARLAMENTAR"] = "Alimentação"
  data$tipoDespesa[data$txtDescricao == "HOSPEDAGEM ,EXCETO DO PARLAMENTAR NO DISTRITO FEDERAL."] = "Hospedagem"
  data$tipoDespesa[data$txtDescricao == "SERVIÇO DE TÁXI, PEDÁGIO E ESTACIONAMENTO"] = "Locomoção"
  data$tipoDespesa[data$txtDescricao == "CONSULTORIAS, PESQUISAS E TRABALHOS TÉCNICOS."] = "Consultoria"
  data$tipoDespesa[data$txtDescricao == "ASSINATURA DE PUBLICAÇÕES"] = "Revistas/Jornais"
  data$tipoDespesa[data$txtDescricao == "SERVIÇO DE SEGURANÇA PRESTADO POR EMPRESA ESPECIALIZADA."] = "Segurança particular"
  data$tipoDespesa[data$txtDescricao == "PASSAGENS TERRESTRES, MARÍTIMAS OU FLUVIAIS"] = "Passagens (exceto aéreas)"
  data$tipoDespesa[data$txtDescricao == "PARTICIPAÇÃO EM CURSO, PALESTRA OU EVENTO SIMILAR"] = "Cursos e palestras"
  
  data = data %>% 
    select(-txtDescricao)
  
  return(data)
}
```

```{r message=FALSE, warning=FALSE, error=FALSE}
require(tidyverse)

preprocess_data = function(raw_data, varsOfInterest) {
  data = raw_data %>%
  
    # Selecting just vars on interest
    select(varsOfInterest) %>%
  
    # Replacing commas for points
    mutate(valorLíquido = as.numeric(gsub(",", ".", raw_data$vlrLiquido))) %>%
    
    # Renaming some vars
    mutate(nomeParlamentar = txNomeParlamentar, year = numAno, month = numMes) %>%
    select(-c(txNomeParlamentar, vlrLiquido, numAno, numMes)) %>%
  
    filter(!is.na(idecadastro)) %>%
    
    # Unify expenditures that are of similar categories with the aim of reduce number o categories
    unify_expenditure_type
  
  return(data)
}

varsOfInterest = c("txNomeParlamentar", "idecadastro", "sgPartido", "sgUF", 
                   "txtDescricao", "txtFornecedor", "vlrLiquido", "numAno", "numMes")
data_ceap = preprocess_data(raw_data, varsOfInterest)
```

## Quais os tipos de despesas com os deputados que, no total, foram maiores do que o investimento com o Museu Nacional?

```{r message=FALSE, warning=FALSE, error=FALSE}
require(lubridate)
require(tidyverse)

data.ceap.by.year = data.ceap %>%
  group_by(year, tipoDespesa) %>%
  summarise(totalExpenditure = sum(valorLíquido)) %>%
  ungroup() %>%
  na.omit()
```

```{r}
theme_set(theme_minimal())
```

```{r message=FALSE, warning=FALSE, error=FALSE}
investiment.mn %>%
  ggplot(aes(x=year, y=investiment), fill="deepink") +
  geom_point() + 
  geom_line(linetype = 2) +
  scale_x_continuous(breaks = c(2001:2018))
```

```{r message=FALSE, warning=FALSE, error=FALSE}

```

```{r message=FALSE, warning=FALSE, error=FALSE}
require(tidyverse)
require(scales)

max.year = max(data.ceap.by.year$year)
min.year = min(data.ceap.by.year$year)

investiment.mn.filter.year = investiment.mn %>%
  filter(year <= max.year & year >= min.year)

ggplot() +
  geom_line(data=data.ceap.by.year, aes(x=year, y=totalExpenditure, group=tipoDespesa), linetype = 2, size=0.3) +
  geom_line(data=investiment.mn.filter.year, aes(x=year, y=investiment), color="red") +
  geom_point(data=investiment.mn.filter.year, aes(x=year, y=investiment), alpha=0.3) + 
  scale_x_continuous(breaks=c(min.year:max.year))

```

```{r message=FALSE, warning=FALSE, error=FALSE}

```

```{r message=FALSE, warning=FALSE, error=FALSE}

```