---
title: "eda-gastos-ceao"
author: "Italo Batista"
date: "29 de agosto de 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r message=FALSE, warning=FALSE, error=FALSE}
library(readr)
library(here)
data.ceap = read_csv(here::here("predictive_data_science/data/ceap.csv"))
limit.ceap = read_csv(here::here("predictive_data_science/data/limiteMensalCEAP.csv"))
```

# Explorando dados

```{r message=FALSE, warning=FALSE, error=FALSE}
summary(data.ceap)
```

```{r message=FALSE, warning=FALSE, error=FALSE}
require(gridExtra)
library(tidyverse)

data.ceap = data.ceap %>%
  mutate(valorGlosa = str_replace_all(valorGlosa,"[[:punct:]]", ".")) %>%
  mutate(valorGlosa = as.numeric(valorGlosa)) 

segment.y = 5000
x.init = min(data.ceap %>% select(valorLíquido))
x.end = max(data.ceap %>% select(valorLíquido))
x.3rd.qrtl = 513
  
histogram = data.ceap %>%
  ggplot() +
  geom_histogram(aes(valorLíquido)) +
  theme_minimal() +
  theme(axis.text.x = element_text(size=8),
        axis.title.x = element_text(size=10),
        axis.text.y = element_text(size=8),
        axis.title.y = element_text(size=10),
        plot.title = element_text(hjust = 0.1, size=10))

plot1 = histogram +
  scale_y_continuous(labels = function(x) format(x, scientific = FALSE))

  plot2 = histogram +
  scale_x_continuous(limits = c(x.init, x.3rd.qrtl)) +
  scale_y_continuous(labels = function(x) format(x, scientific = FALSE)) +
  ggtitle("Sem valores extremos superiores")

plot3 = histogram +
  scale_x_continuous(limits = c(x.init, x.end)) +
  scale_y_continuous(trans='log2',
                     labels = function(x) format(x, scientific = FALSE)) +
  ggtitle("Escala logarítmica")

plot4 = histogram +
  scale_x_continuous(limits = c(x.init, x.3rd.qrtl)) +
  scale_y_continuous(trans='log2',
                     labels = function(x) format(x, scientific = FALSE)) +
  ggtitle("Escala logarítmica e sem valores extremos superiores")

grid.arrange(plot1, plot2, plot3, plot4, ncol=2)
```

# Perguntas

## 1. Quais são os deputados que gastaram mais dinheiro da CEAP? Quais são os mais econômicos? 

```{r message=FALSE, warning=FALSE, error=FALSE}
ranking.expenditures = data.ceap %>%
  filter(valorLíquido > 0) %>%
  group_by(nomeParlamentar) %>%
  summarise(totalExpenditure = sum(valorLíquido)) %>%
  ungroup() %>%
  arrange(totalExpenditure)

top.spenders = ranking.expenditures %>%
  top_n(10) %>%
  mutate(expenses_gat = "Spender")

top.economicals = ranking.expenditures %>%
  top_n(-10) %>%
  mutate(expenses_gat = "Economical")

ranking.expenditures = rbind(top.spenders, top.economicals)
```

```{r message=FALSE, warning=FALSE, error=FALSE}
expense.min = min(ranking.expenditures$totalExpenditure)
expense.max = max(ranking.expenditures$totalExpenditure)

m_breaks = ranking.expenditures %>% select(totalExpenditure) %>% distinct()

ranking.expenditures %>%
  mutate(nomeParlamentar = reorder(nomeParlamentar, totalExpenditure)) %>%
  
  ggplot(aes(nomeParlamentar, totalExpenditure, fill=expenses_gat, color=expenses_gat)) +
  geom_bar(stat = "identity") +
  geom_text(data = top.economicals, size=2.8, color="#FF6600", hjust=1.1, fontface="bold", aes(label=totalExpenditure)) +
  geom_text(data = top.spenders, size=2.8, color="white", hjust=1.1, fontface="bold", aes(label=totalExpenditure)) +
  coord_flip() +
  
  scale_y_continuous(limits = c(expense.min - 100000, expense.max)) +
  scale_fill_manual(labels = c("10+ Econômicos", "10+ Gastadores"), values=c("#FF6600", "#4F0C68")) +
  scale_color_manual(labels = c("10+ Econômicos", "10+ Gastadores"), values=c("#FF6600", "#4F0C68")) +
  
  theme_minimal() +
  theme(plot.title = element_text(hjust = -1.5),
        legend.title = element_blank(), legend.position = "top") +
    labs(title="Deputados que mais e menos gastam o auxílio da CEAP", 
       y ="Gasto total", x = "Nome do Parlamentar")
```

## 2. Quais os estados cujos deputados gastam mais no exterior? Quais os estados cujos deputados gastam menos no exterior?

```{r message=FALSE, warning=FALSE, error=FALSE}
require(scales)

SPENT_ABROAD = 2

data.ceap.aggr.uf = data.ceap %>%
  filter(tipoDocumento == SPENT_ABROAD) %>%
  group_by(sgUF) %>%
  summarise(totalExpenditure = sum(valorLíquido)) %>%
  ungroup()

data.ceap.aggr.uf %>%
  mutate(sgUF = reorder(sgUF,totalExpenditure)) %>%
  ggplot(aes(sgUF, totalExpenditure, color = totalExpenditure > 0)) +
  geom_segment(aes(x = sgUF, xend = sgUF, y = 0, yend = totalExpenditure), size = 1.1, alpha = 0.6) +
  geom_point(size = 3.5) +
  coord_flip() +
  
  scale_color_manual(values=c("#AD1457"), name = "") +
  scale_y_continuous(label = unit_format(unit = "k", scale = 1e-3)) + 

  theme_minimal() +
  theme(legend.position = "NA") +
    labs(title="Federation unities whose congressmen more and less spent abroad", 
       x ="Federation Unity", y = "Total Expenditure (R$)")
```

## 3. Quais os partidos cujos parlamentares mais usam CEAP no estado da Paraíba? Quais são os que menos usam? Mesmas perguntas considerando valores em R$.

```{r message=FALSE, warning=FALSE, error=FALSE}
require(gridExtra)
library(scales)
source("../color_pallet.R")

data.ceap.pb = data.ceap %>%
  filter(sgUF == "PB") %>%
  group_by(sgPartido) %>%
  summarise(useCEAP = n(),
         totalExpenditure = sum(valorLíquido))

get_plot_qst_3 <- function(yVar, title, yLab, yScaleUnity, yScaleRound) {
  
  y.min = 0
  y.max = max(yVar)
  y.padding = ifelse(yScaleUnity == "k", 1e+3, 1e+6) * 0.5
  
  plot = data.ceap.pb %>%
    mutate(sgPartido = reorder(sgPartido, -yVar)) %>%
    ggplot(aes(sgPartido, yVar, color = sgPartido, fill = sgPartido)) +
    geom_bar(stat = "identity") +
    geom_text(aes(label=sgPartido), hjust=-0.25, angle=90, color="black", size=2.5) +

    scale_color_drsimonj(discrete = TRUE, palette = "hotpink") +
    scale_fill_drsimonj(discrete = TRUE, palette = "hotpink") + 
    scale_y_continuous(label = unit_format(unit = yScaleUnity, scale = yScaleRound),
                       limits = c(y.min, y.max + y.padding)) + 
    
    theme_minimal() +
    labs(title=title, x ="Federation Unity", y = yLab) +
    theme(legend.position = "NA",
          axis.text.x = element_text(size=6.5),
          axis.ticks.x = element_blank())
  
  return(plot)
}

plot1 = get_plot_qst_3(data.ceap.pb$totalExpenditure, 
                       title = "Political parties that most use CEAP at Paraíba", 
                       yLab = "Total Expenditure (R$)", yScaleUnity = "m", yScaleRound = 1e-6)

plot2 = get_plot_qst_3(data.ceap.pb$useCEAP, title = "", 
                       yLab = "Quantity of times used", yScaleUnity = "k", yScaleRound = 1e-3)

grid.arrange(plot1, plot2, ncol=2)
```

## 4. Quais os deputados que mais ultrapassam o limite de CEAP do seu estado? Os dados com os limites de CEAP por estado estão disponíveis neste link.

```{r message=FALSE, warning=FALSE, error=FALSE}
# Quanto cada deputado gastou cada mês
library(lubridate)

data.ceap.month = data.ceap %>%
  mutate(month = month(dataEmissao),
         year = year(dataEmissao)) %>%
  group_by(month, year, nomeParlamentar, sgUF) %>%
  summarise(totalExpenditureMonth = sum(valorLíquido)) %>%
  ungroup()
```

```{r message=FALSE, warning=FALSE, error=FALSE}
# Adicionar limite mensal
data.ceap.month  = left_join(data.ceap.month, limit.ceap, by=c("sgUF"="UF"))
```

```{r message=FALSE, warning=FALSE, error=FALSE}
data.ceap.month$exceeded_limit = data.ceap.month$totalExpenditureMonth > data.ceap.month$limite_mensal
```

```{r message=FALSE, warning=FALSE, error=FALSE}
data.ceap.month.exceeded = data.ceap.month %>%
  filter(exceeded_limit == TRUE) %>%
  group_by(nomeParlamentar, sgUF) %>% 
  summarise(qntExceeded = n()) %>%
  ungroup() %>%
  group_by(sgUF) %>%
  top_n(4) %>% 
  ungroup()
```

```{r message=FALSE, warning=FALSE, error=FALSE, fig.height=6, fig.width=8}
data.ceap.month.exceeded %>%
  arrange(qntExceeded) %>%
  top_n(15) %>%
  
  ggplot(aes(x = reorder(nomeParlamentar, qntExceeded), 
             y = qntExceeded, fill = qntExceeded, alpha = qntExceeded, width = 0.5)) +
  geom_bar(stat = "identity", show.legend = FALSE) +
  
  coord_flip() +
  facet_wrap(~sgUF, ncol = 2, scales = "free_y") +
  scale_alpha_continuous(range = c(0.6, 1)) +
  scale_fill_drsimonj(discrete = FALSE, palette = "hot") +
  scale_y_continuous(limits = c(0, max(data.ceap.month.exceeded$qntExceeded))) +
  
  theme_minimal() +
  theme(strip.text=element_text(hjust=0, face = "italic"),
        axis.text.y = element_text(size=7)) +
  labs(title = "The top 15 brazilian congressmen that exceeded CEAP limit more times", 
       subtitle = "Grouped by UF",
       x = NULL, y = "Quantity of times (months) exceeded") 
```

## 5. Quais estados cujos parlamentares gastam mais com passagens aéreas?

```{r message=FALSE, warning=FALSE, error=FALSE}
data.ceap.uf.airfare = data.ceap %>%
  filter(tipoDespesa == "PASSAGENS AÉREAS") %>%
  group_by(sgUF) %>%
  summarise(totalExpenditure = sum(valorLíquido)) %>%
  ungroup() 
```

```{r message=FALSE, warning=FALSE, error=FALSE}
data.ceap.uf.airfare %>%
  ggplot(aes(x=reorder(sgUF, totalExpenditure), 
             y=totalExpenditure, color=sgUF, size=totalExpenditure)) +
  geom_point() +
  geom_text(aes(label=sgUF), size = 3, hjust=-0.15, vjust=1.9) +
  
  scale_color_drsimonj(palette = "mixed") +
  scale_size_continuous(trans = "log10") +
  scale_y_continuous(label = unit_format(unit = "k", scale = 1e-3),
                     breaks = round(seq(0, max(data.ceap.uf.airfare$totalExpenditure), by = 100000),1)) + 
  
  theme_minimal() +
  theme(legend.position = "NA",
        axis.text.x = element_blank(), axis.title.x = element_blank()) +
  labs(title="Federation Unities that most spent with airfares",
       y="Amount spent with airfare in R$")
```

## 6. Escolha três partidos e responda: Quais são os tipos de despesa mais utilizados no uso da CEAP pelos deputados desses partidos? Mesma pergunta considerando valores em R$.

```{r  message=FALSE, warning=FALSE, error=FALSE}
selected.pp = c("PMDB", "PSDB", "PT")

data.ceap.type.exp = data.ceap %>%
  filter(sgPartido %in% selected.pp) %>%
  group_by(sgPartido, tipoDespesa) %>%
  summarise(useCEAP = n(),
         totalExpenditure = sum(valorLíquido)) %>%
  ungroup()
```

```{r message=FALSE, warning=FALSE, error=FALSE}
plot1 = data.ceap.type.exp %>%
  na.omit() %>%
  group_by(sgPartido) %>%
  top_n(2) %>%
  ungroup() %>%
  arrange(totalExpenditure) %>%

  ggplot(aes(x = reorder(totalExpenditure, tipoDespesa), 
             y = totalExpenditure, fill = tipoDespesa, width = 0.5)) +
  geom_bar(stat = "identity", show.legend = FALSE) +
  geom_text(aes(label=tipoDespesa), size = 2.3, color = "black", hjust = 0.9, fontface = "bold") +
  
  coord_flip() +
  facet_wrap(~sgPartido, ncol = 1, scales = "free_y") +
  scale_fill_drsimonj(discrete = TRUE, palette = "cool") +
  scale_y_continuous(label = unit_format(unit = "m", scale = 1e-6),
                     limits = c(0, max(data.ceap.type.exp$totalExpenditure))) +
  
  theme_minimal() +
  theme(strip.text=element_text(hjust=0, face = "italic"),
        axis.text.y = element_blank(), legend.position = "NA")+
  labs(y = "Total Expenditure (R$)", x = NULL)
```

```{r message=FALSE, warning=FALSE, error=FALSE}
require(gridExtra)

p2.y.max = max(data.ceap.type.exp$useCEAP)
p2.y.scaleRound = 1e+4
  
plot2 = data.ceap.type.exp %>%
  na.omit() %>%
  group_by(sgPartido) %>%
  top_n(2) %>%
  ungroup() %>%
  arrange(totalExpenditure) %>%

  ggplot(aes(x = reorder(useCEAP, tipoDespesa), 
             y = useCEAP, fill = tipoDespesa, width = 0.5)) +
  geom_bar(stat = "identity", show.legend = FALSE) +
  geom_text(aes(label=tipoDespesa), size = 2.3, color = "black", hjust = 0.1, fontface = "bold") +
  
  coord_flip() +
  facet_wrap(~sgPartido, ncol = 1, scales = "free_y") +
  scale_fill_drsimonj(discrete = TRUE, palette = "cool") +
  scale_y_continuous(label = unit_format(unit = "k", scale = 1e-3),
                     limits = c(0, p2.y.max + p2.y.scaleRound)) +
  
  theme_minimal() +
  theme(strip.text=element_text(hjust=0, face = "italic"),
        axis.text.y = element_blank(), legend.position = "NA")+
  labs(y = "Quantity of times CEAP was used", x = NULL)

grid.arrange(plot1, plot2, ncol=2)
```

# qual a data mes/ano em que os deputados mais gastaram?